#! /usr/bin/env node
'use strict';function _defineProperty(c,f,g){return f in c?Object.defineProperty(c,f,{value:g,enumerable:!0,configurable:!0,writable:!0}):c[f]=g,c}var PQueue=require('p-queue-safe'),request=require('request-promise'),cheerio=require('cheerio'),json=require('jsonfile'),argv=require('yargs').argv,ms=require('ms'),progress=require('progress'),fs=require('fs'),start=+new Date,config={};try{config=require(process.cwd()+'/conf.json')}catch(c){config=argv}var page=1,links=[],heartbeat=null,bar=new progress(':bar :percent :len link saved',{total:config.limit?config.limit:config.end-config.start,width:20}),special='string'==typeof config.special?config.special.split(',').map(function(c){return _defineProperty({},c.split(':')[0].trim(),c.split(':')[1].trim().split('*'))}).reduce(function(c,f){return Object.assign(c,f)}):null;try{config.heartbeat&&(heartbeat=require(process.cwd()+'/heartbeat.js'))}catch(c){console.log('heartbeat.js file not found.'),process.exit()}var jumper=function(c,f,g){return'<'===g?f=c(f).prev():'^'===g?f=c(f).parent():'>'===g?f=c(f).next():void 0,c(f)},queue=new PQueue({retry:!0}),crawl=function(c){var f=cheerio.load(c);f(config.list).length&&page<=(config.limit?config.limit:config.end-config.start)?(bar.tick({len:links.length}),f(config.list).each(function(g,h){var j={url:f(h).find(config.link).attr('href'),title:f(h).find(config.title).text().trim().replace(/[\n\t]/g,'')};for(var k in special)if(special[k][0].match(/[<\^>]/)){var l=special[k][0].match(/[<\^>]/)[0],m=special[k][0].replace(/[<\^> ]/g,''),n=special[k][1],o=k;k=jumper(f,h,l),j[o]='text'===n?k.find(m).text():k.find(m).attr(n)}else j[k]='text'===special[k][1]?f(h).find(special[k][0]).text():f(h).find(special[k][0]).attr(special[k][1]);links.push(j),heartbeat&&heartbeat(j)}),queue.add(function(){return request(''+config.site+ ++page)}).then(crawl)):(bar.tick({len:links.length}),console.log('Completed in '+ms(+new Date-start)+'.\n'+links.length+' link saved to report.json file.'),json.writeFileSync(process.cwd()+'/'+(config.file?config.file:'report')+'.json',links))};queue.add(function(){return request(''+config.site+page)}).then(crawl);
