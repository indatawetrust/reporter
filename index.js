#! /usr/bin/env node
'use strict';var PQueue=require('p-queue'),request=require('request-promise'),cheerio=require('cheerio'),json=require('jsonfile'),argv=require('yargs').argv,ms=require('ms'),progress=require('progress'),fs=require('fs'),start=+new Date,page=1,links=[],config={},heartbeat=null,bar=new progress(':bar :percent',{total:argv.limit,width:20});try{config=fs.statSync(process.cwd()+'/conf.json')}catch(a){config.site=argv.site,config.list=argv.list,config.link=argv.link,config.title=argv.title,config.limit=argv.limit,config.heartbeat=argv.heartbeat}try{config.heartbeat&&(heartbeat=require(process.cwd()+'/heartbeat.js'))}catch(a){console.log('heartbeat.js file not found.'),process.exit()}var queue=new PQueue({concurrency:1}),crawl=function(a){var b=cheerio.load(a);b(config.list).length&&page<=argv.limit?(bar.tick(1),b(config.list).each(function(c,d){var f={url:b(d).find(config.link).attr('href'),text:b(d).find(config.title).text().trim().replace(/[\n\t]/g,'')};links.push(f),heartbeat&&heartbeat(f)}),queue.add(function(){return request(''+config.site+ ++page)}).then(crawl)):(console.log('Completed in '+ms(+new Date-start)+'.\n'+links.length+' link saved to report.json file.'),json.writeFileSync(process.cwd()+'/report.json',links))};queue.add(function(){return request(''+config.site+page)}).then(crawl);
