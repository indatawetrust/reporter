#! /usr/bin/env node
const PQueue=require('p-queue-safe'),request=require('request-promise'),cheerio=require('cheerio'),json=require('jsonfile'),argv=require('yargs').argv,ms=require('ms'),progress=require('progress'),fs=require('fs'),start=+new Date;let config={};try{config=require(`${process.cwd()}/conf.json`)}catch(c){config=Object.assign(argv,{limit:argv.limit||10})}let page=1,links=[],heartbeat=null,bar=new progress(':bar :percent :len link saved',{total:config.limit?config.limit:config.end-config.start,width:20}),special='string'==typeof config.special?config.special.split(',').map(c=>({[c.split(':')[0].trim()]:c.split(':')[1].trim().split('*')})).reduce((c,f)=>Object.assign(c,f)):null;try{config.heartbeat&&(heartbeat=require(`${process.cwd()}/heartbeat.js`))}catch(c){console.log(`heartbeat.js file not found.`),process.exit()}const jumper=(c,f,g)=>{return'<'===g?f=c(f).prev():'^'===g?f=c(f).parent():'>'===g?f=c(f).next():void 0,c(f)},queue=new PQueue({retry:!0}),crawl=c=>{let f=cheerio.load(c);f(config.list).length&&page<=(config.limit?config.limit:config.end-config.start)?(bar.tick({len:links.length}),f(config.list).each((g,h)=>{let j={url:config.link?f(h).find(config.link).attr('href'):f(h).attr('href'),title:f(h).find(config.title).text().trim().replace(/[\n\t]/g,'')};for(let l in special)if(special[l][0].match(/[<\^>]/)){let m=special[l][0].match(/[<\^>]/)[0],n=special[l][0].replace(/[<\^> ]/g,''),o=special[l][1],p=l;l=jumper(f,h,m),j[p]='text'===o?l.find(n).text().replace(/\r|\t|\n/g,'').replace(/ {2,}/g,'').trim():l.find(n).attr(o)}else j[l]='text'===special[l][1]?f(h).find(special[l][0]).text().replace(/\r|\t|\n/g,'').replace(/ {2,}/g,'').trim():f(h).find(special[l][0]).attr(special[l][1]);let k=[];for(let l in j)k.push(j[l]&&''!=j[l].trim());1<k.filter(l=>l).length&&links.push(j),heartbeat&&heartbeat(j)}),queue.add(()=>request(`${config.site}${++page}`)).then(crawl)):(bar.tick({len:links.length}),console.log(`Completed in ${ms(+new Date-start)}.\n${links.length} link saved to ${config.file||'report'}.json file.`),json.writeFileSync(`${process.cwd()}/${config.file||'report'}.json`,links))};queue.add(()=>request(`${config.site}${page}`)).then(crawl);
